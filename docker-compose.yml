services:
  sage-server:
    restart: always
    build:
      context: .
      dockerfile: docker/Dockerfile.server
    image: sage-server:v1.0
    container_name: sage-server
    volumes:
      - ${ROOT_DATA_DIR}/sage-server/agent_workspace:/app/agent_workspace
      - ${ROOT_DATA_DIR}/sage-server/logs:/app/logs
      - ${ROOT_DATA_DIR}/sage-server/data:/app/data
      - ${ROOT_DATA_DIR}/sage-server/skills:/app/skills
    ports:
      - 30050:8080
    env_file:
      - .env
    mem_limit: 4g
    cpus: 1.0

  sage-web:
    restart: always
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      args:
        VITE_SAGE_API_BASE_URL: ${SAGE_API_BASE_URL}
        VITE_SAGE_TRACE_WEB_URL: ${SAGE_TRACE_WEB_URL}
    image: sage-web:v1.0
    container_name: sage-web
    ports:
      - 30051:80
    environment:
      TZ: 'Asia/Shanghai'
      VITE_SAGE_API_BASE_URL: ${SAGE_API_BASE_URL}
      VITE_SAGE_TRACE_WEB_URL: ${SAGE_TRACE_WEB_URL}
    depends_on:
      - sage-server
    mem_limit: 512m
    cpus: 0.5
  sage-mysql:
    restart: always
    image: docker.m.daocloud.io/mysql:8.4
    container_name: sage-mysql
    ports:
      - 30052:3306
    environment:
      TZ: 'Asia/Shanghai'
      MYSQL_ROOT_PASSWORD: ${SAGE_MYSQL_PASSWORD}
      MYSQL_ROOT_HOST: '%'
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ${ROOT_DATA_DIR}/mysql/data:/var/lib/mysql
      - ${ROOT_DATA_DIR}/mysql/conf:/etc/mysql/conf.d
    mem_limit: 1g
    cpus: 1.0
  sage-es:
    restart: always
    build:
      context: .
      dockerfile: docker/Dockerfile.es
    image: sage-es:v1.0
    container_name: sage-es
    ports:
      - 30053:9200
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - ELASTIC_PASSWORD=${SAGE_ELASTICSEARCH_PASSWORD}
      - xpack.security.enabled=false
      - TAKE_FILE_OWNERSHIP=true
      - "ES_JAVA_OPTS=-Xms1024m -Xmx1024m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ${ROOT_DATA_DIR}/es/data/node:/usr/share/elasticsearch/data
    mem_limit: 2g
    cpus: 1.0
  sage-rustfs:
    image: docker.m.daocloud.io/rustfs/rustfs:latest
    ports:
      - 30054:9000
      - 30055:9001
    volumes:
      - ${ROOT_DATA_DIR}/rustfs/data:/data
    container_name: sage-rustfs
    restart: always
    environment:
      - RUSTFS_ADDRESS=0.0.0.0:9000
      - RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001
      - RUSTFS_CONSOLE_ENABLE=true
      - RUSTFS_CORS_ALLOWED_ORIGINS=*
      - RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS=*
      - RUSTFS_ACCESS_KEY=${SAGE_S3_ACCESS_KEY}
      - RUSTFS_SECRET_KEY=${SAGE_S3_SECRET_KEY}
      - RUSTFS_OBS_LOGGER_LEVEL=info
    healthcheck:
      test:
        [
          "CMD",
          "sh", "-c",
          "curl -f http://127.0.0.1:9000/health && curl -f http://127.0.0.1:9001/rustfs/console/health"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    mem_limit: 1g
    cpus: 0.5
  sage-jaeger:
    image:  docker.m.daocloud.io/jaegertracing/all-in-one:1.76.0
    container_name: sage-jaeger
    restart: always
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "30056:16686" # UI
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    mem_limit: 1g
    cpus: 0.5
