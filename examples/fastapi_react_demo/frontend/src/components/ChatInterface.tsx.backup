import React, { useState, useImperativeHandle, forwardRef } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { Message, ChatSettings } from '../types/chat';
import { useChatMessages } from '../hooks/useChatMessages';
import MessageList from './MessageList';
import ChatInput from './ChatInput';
import ToolDetailPanel from './ToolDetailPanel';
import { ToolCallData } from '../types/toolCall';
import { ChatHistoryItem } from '../hooks/useChatHistory';

interface ChatInterfaceProps {
  currentChatId?: string;
  loadedMessages?: ChatHistoryItem['messages'] | null;
}

export interface ChatInterfaceRef {
  startNewChat: () => void;
  loadChat: (messages: ChatHistoryItem['messages']) => void;
}

const ChatInterface = forwardRef<ChatInterfaceRef, ChatInterfaceProps>(
  ({ currentChatId, loadedMessages }, ref) => {
    const [inputValue, setInputValue] = useState('');
    const [useDeepThink, setUseDeepThink] = useState(false);
    const [useMultiAgent, setUseMultiAgent] = useState(false);
    const [sessionId] = useState(uuidv4());
    const [toolPanelVisible, setToolPanelVisible] = useState(false);
    const [selectedToolCall, setSelectedToolCall] = useState<ToolCallData | null>(null);

    const {
      messages,
      isLoading,
      setIsLoading,
      addLoadingMessage,
      addUserMessage,
      handleMessageChunk,
      addErrorMessage,
      clearMessages,
      setMessages
    } = useChatMessages();

    // æš´éœ²ç»™çˆ¶ç»„ä»¶çš„æ–¹æ³•
    useImperativeHandle(ref, () => ({
      startNewChat: () => {
        clearMessages();
        setInputValue('');
        setIsLoading(false);
      },
      loadChat: (chatMessages: ChatHistoryItem['messages']) => {
        setMessages(chatMessages.map(msg => ({
          ...msg,
          timestamp: new Date(msg.timestamp)
        })));
        setInputValue('');
        setIsLoading(false);
      }
    }));

    const handleSendMessage = async () => {
      if (!inputValue.trim() || isLoading) return;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      const userMessage = addUserMessage(inputValue.trim());
      
      // æ·»åŠ loadingæ¶ˆæ¯
      const settings: ChatSettings = { useDeepThink, useMultiAgent };
      addLoadingMessage(settings);
      
      setInputValue('');
      setIsLoading(true);

      try {
        // æ„å»ºè¯·æ±‚æ•°æ®
        const requestData = {
          type: 'chat',
          messages: [...messages, userMessage].map(msg => ({
            role: msg.role,
            content: msg.content,
            message_id: msg.id,
            type: msg.type || 'normal'
          })),
          use_deepthink: useDeepThink,
          use_multi_agent: useMultiAgent,
          session_id: sessionId
        };

        console.log('ğŸŒ å‘èµ·Fetchè¯·æ±‚:', 'http://localhost:40039/api/chat-stream');
        const response = await fetch('http://localhost:40039/api/chat-stream', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData),
        });

        console.log('ğŸ“¡ æ”¶åˆ°å“åº”:', response.status, response.statusText);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        console.log('ğŸ“º è¿™æ˜¯æµå¼å“åº”ï¼Œä¸èƒ½åœ¨è¿™é‡Œè¯»å–body');

        // å¤„ç†æµå¼å“åº”
        const reader = response.body?.getReader();
        if (!reader) {
          throw new Error('æ— æ³•è·å–å“åº”æµ');
        }

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = new TextDecoder().decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                console.log('ğŸ“¦ æ”¶åˆ°æ•°æ®:', data);
                
                switch (data.type) {
                  case 'chat_chunk':
                    handleMessageChunk(data);
                    break;
                  case 'chat_complete':
                    setIsLoading(false);
                    console.log('âœ… å¯¹è¯å®Œæˆ');
                    break;
                  case 'error':
                    setIsLoading(false);
                    addErrorMessage(data.message);
                    break;
                }
              } catch (error) {
                console.error('âŒ è§£æJSONå¤±è´¥:', error, line);
              }
            }
          }
        }

      } catch (error) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        setIsLoading(false);
        addErrorMessage(`è¿æ¥é”™è¯¯: ${error}`);
      }
    };

    const handleExampleClick = (example: string) => {
      setInputValue(example);
    };

    const handleToolCallClick = (toolCall: ToolCallData) => {
      setSelectedToolCall(toolCall);
      setToolPanelVisible(true);
    };

    const handleToolPanelClose = () => {
      setToolPanelVisible(false);
      setSelectedToolCall(null);
    };

    return (
      <div style={{
        height: '100vh', 
        display: 'flex', 
        flexDirection: 'row',
        overflow: 'hidden',
        background: '#f8fafc'
      }}>
        {/* ä¸»èŠå¤©åŒºåŸŸ */}
        <div style={{
          flex: 1,
          display: 'flex', 
          flexDirection: 'column',
          overflow: 'hidden',
          transition: 'all 0.3s ease',
          marginRight: toolPanelVisible ? '400px' : '0'
        }}>
          {/* æ¶ˆæ¯åˆ—è¡¨ */}
          <MessageList 
            messages={messages} 
            onExampleClick={handleExampleClick}
          />

          {/* è¾“å…¥åŒºåŸŸ */}
          <ChatInput
            value={inputValue}
            onChange={setInputValue}
            onSend={handleSendMessage}
            isLoading={isLoading}
            useDeepThink={useDeepThink}
            useMultiAgent={useMultiAgent}
            onDeepThinkChange={setUseDeepThink}
            onMultiAgentChange={setUseMultiAgent}
          />
        </div>

        {/* å·¥å…·è¯¦æƒ…ä¾§è¾¹æ  */}
        <ToolDetailPanel
          visible={toolPanelVisible}
          toolCall={selectedToolCall}
          onClose={handleToolPanelClose}
        />
      </div>
    );
  }
);

export default ChatInterface; 