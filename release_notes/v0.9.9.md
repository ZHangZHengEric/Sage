# Sage v0.9.9 Release Notes

**Release Date:** 2026-02-25  
**Version:** v0.9.9

---

## 🌟 Overview

v0.9.9 是 Sage 企业级智能体平台的重要功能增强版本。本版本聚焦于**多智能体协作架构升级**、**任务调度生态完善**、**开发者体验优化**三大核心方向，通过引入全新的 MCP 服务生态、重构工具选择机制、增强前端交互能力，显著提升了系统的可扩展性、智能化水平和用户体验。

**核心数据：**
- 171 个文件变更，+13,288 行 / -6,343 行
- 3 个全新 MCP 服务（Task Scheduler、Agent Hub、Brave Search）
- 5+ 个前端核心组件升级
- 完整的多语言支持（中/英/葡）

---

## 🤖 多智能体协作架构升级

### 1. 智能工具选择机制重构

**背景与动机：**
在之前的版本中，不同 Agent（SimpleAgent、TaskExecutorAgent 等）各自实现了工具选择逻辑，导致代码冗余且维护困难。LLM 直接输出工具名称的方式在工具数量增多时容易出现解析错误。

**核心改进：**

**工具 ID 化机制**
- LLM 现在输出工具 ID 序号（如 `[1, 5, 8]`）而非工具名称
- 工具列表展示时附带序号（`1. tool_name`），便于 LLM 理解
- 内部通过 ID 映射到实际工具，提升解析准确性和一致性
- 支持整数和字符串两种格式的工具 ID，保持向后兼容

**架构统一**
- 工具选择逻辑统一收拢到 AgentBase 基类
- 所有 Agent（SimpleAgent、TaskExecutorAgent 等）继承统一实现
- 工具数量阈值从 10 调整为 15，小工具集场景直接返回全部工具
- 自动过滤 `complete_task` 工具，避免误调用

**业务影响：**
- 工具推荐的准确性提升，减少因工具名称解析错误导致的失败
- 代码维护成本降低，新增 Agent 无需重复实现工具选择逻辑
- 支持更大规模的工具集（15 个以内直接全量返回）

---

### 2. Fibre 多智能体架构增强

**自定义子智能体支持**
- 支持在 Agent 配置中定义自定义子智能体（Custom Sub Agents）
- 每个子智能体可独立配置系统提示词、可用工具、技能、工作流
- 运行时动态初始化和调度子智能体
- 子智能体间通过消息机制通信

**Orchestrator 核心调度优化**
- 统一的会话上下文管理，支持主从会话隔离
- 子智能体生命周期管理（创建、运行、销毁）
- 消息路由和负载均衡机制
- 资源调度和并发控制

**业务影响：**
- 支持复杂任务的多智能体协作场景
- 企业可配置专属子智能体处理特定业务领域
- 提升任务执行的并行度和效率

---

## 📅 任务调度生态完善

### 1. Task Scheduler MCP 服务

**核心定位：**
独立的任务调度服务，为所有 Agent 提供统一的任务管理能力，支持定时任务、循环任务和自动执行。

**功能特性：**

**任务生命周期管理**
- 任务创建：支持一次性任务和循环任务（Cron 表达式）
- 任务查询：按 Agent、会话、状态等多维度筛选
- 任务执行：到期自动触发，支持重试机制
- 任务归档：执行历史自动记录，支持审计追踪

**循环任务支持**
- 基于 Cron 表达式的灵活调度
- 支持分钟、小时、日、周、月级别的循环
- 循环规则 JSON 化存储，便于扩展

**自动执行机制**
- 独立线程轮询检测到期任务
- 自动调用 Sage API 触发 Agent 执行
- 执行结果异步回调，更新任务状态
- 失败任务自动重试（最多 3 次）

**数据持久化**
- SQLite 数据库存储，无需额外依赖
- 任务表 + 历史表双表设计
- 支持任务内容压缩存储（返回后 1000 字符）

**业务影响：**
- Agent 可创建定时任务，实现延迟执行和周期性任务
- 支持"提醒类"应用场景（如每日报表生成、定时数据同步）
- 任务执行与主流程解耦，提升系统稳定性

---

### 2. Agent Hub MCP 服务

**核心定位：**
Agent 间的消息通信中心，实现多智能体间的协作与协调。

**功能特性：**

**Agent 注册与发现**
- 自动注册机制，Agent 首次发消息时自动录入
- Agent 元数据管理（名称、描述、能力标签）
- 支持 Agent 在线状态检测

**消息通信机制**
- 点对点消息：一对一私密通信
- 广播消息：一对多群发通知
- 消息类型：文本、选项（支持快速回复）、定时消息

**消息状态追踪**
- 完整的消息状态机：pending → sent → delivered → read
- 消息历史查询，支持分页和筛选
- 未读消息提醒和计数

**业务影响：**
- 支持"主管-下属"多智能体协作模式
- Agent 可委托任务给其他 Agent 并追踪进度
- 实现跨会话的 Agent 通信和能力共享

---

### 3. Brave Search MCP 服务

**核心定位：**
网络搜索能力集成，为 Agent 提供实时信息获取能力。

**功能特性：**

**搜索能力**
- 集成 Brave Search 引擎，无需翻墙即可使用
- 支持网页搜索和新闻搜索
- 搜索结果结构化返回（标题、链接、摘要）

**内容获取**
- 支持获取搜索结果页面的完整内容
- 自动将 HTML 转换为 Markdown 格式
- 图片和链接资源提取

**反爬优化**
- 内置多 User-Agent 轮换
- 请求频率控制和随机延迟
- 失败自动重试机制

**业务影响：**
- Agent 可获取最新网络信息，回答时效性问题
- 支持"研究类"任务（如竞品分析、市场调研）
- 弥补训练数据截止时间的局限性

---

## 🎨 开发者体验优化

### 1. 暗色主题支持

**设计目标：**
提供舒适的夜间使用体验，减少视觉疲劳。

**实现方案：**
- 基于 Tailwind CSS 的 Dark Mode 实现
- 支持亮色、暗色、跟随系统三种模式
- 主题偏好持久化存储（localStorage）
- 平滑过渡动画，切换无闪烁

**覆盖范围：**
- 侧边栏、聊天界面、设置面板全量适配
- 代码块、表格、图表等特殊组件优化
- 图片和图标自动反色处理

**业务影响：**
- 提升夜间使用体验
- 符合现代应用设计趋势
- 减少长时间使用的视觉疲劳

---

### 2. 模型提供商管理

**背景与动机：**
原版本模型配置分散在多个配置文件中，管理不便。企业场景需要支持多模型源动态切换。

**核心功能：**

**提供商管理**
- 独立的模型提供商列表页面
- 支持 OpenAI、Azure、Claude、本地模型等多种类型
- 动态添加、编辑、删除提供商配置

**参数配置**
- 基础参数：base_url、api_key、model_name
- 生成参数：max_tokens、temperature、top_p、presence_penalty
- 高级参数：max_model_len（上下文长度限制）

**默认配置机制**
- 支持设置全局默认提供商
- Agent 级别可覆盖默认配置
- 请求级别可临时指定提供商

**业务影响：**
- 企业可灵活配置多个模型源，实现负载均衡
- 支持敏感数据场景的私有化模型部署
- 便于模型版本升级和 A/B 测试

---

### 3. 子任务可视化

**核心场景：**
多智能体协作时，用户需要了解子任务的执行进度和结果。

**功能特性：**

**子会话面板（SubSessionPanel）**
- 侧滑面板展示子任务执行过程
- 实时显示子 Agent 的消息流
- 支持子任务嵌套（子任务再派生子任务）

**消息卡片优化**
- Agent 卡片消息：展示子 Agent 的基本信息和执行结果
- 委托任务消息：展示任务委派和接收状态
- 工具调用消息：优化工具参数和结果的展示

**交互增强**
- 点击可查看子任务详细会话
- 支持子任务的暂停、恢复、终止操作
- 子任务状态实时同步（运行中/已完成/失败）

**业务影响：**
- 提升多智能体协作的透明度
- 用户可实时了解任务执行进度
- 便于问题定位和调试

---

### 4. Agent 配置流程优化

**简化创建流程**
- 原 3 步创建流程简化为 2 步
- 移除冗余的高级配置步骤
- 常用配置项前置，减少点击次数

**系统提示词优化**
- 支持空系统提示词，触发后端默认逻辑
- 提供系统提示词模板库（快速选择）
- 实时预览系统提示词效果

**技能选择增强**
- 技能分类展示（开发、办公、数据分析等）
- 技能搜索和筛选
- 技能依赖自动检测和提示

**业务影响：**
- 降低 Agent 创建门槛，提升新手体验
- 减少配置错误，提升 Agent 运行稳定性
- 加快企业场景下的 Agent 批量部署

---

## 🔧 核心框架增强

### 1. 上下文预算管理

**背景与动机：**
LLM 上下文长度有限，长对话场景容易出现上下文溢出导致性能下降或失败。

**核心机制：**

**智能压缩策略**
- 基于 Token 数量的动态压缩
- 保留关键消息（系统提示、最近对话）
- 历史消息摘要提取，而非简单截断

**预算分配**
- 系统消息预留固定预算
- 用户消息和工具消息按比例分配
- 支持运行时动态调整预算策略

**多层级压缩**
- 轻度压缩：移除冗余格式和空行
- 中度压缩：合并连续同类消息
- 重度压缩：历史消息摘要化

**业务影响：**
- 支持更长对话场景，提升用户体验
- 优化 Token 使用，降低 API 调用成本
- 减少上下文溢出导致的失败

---

### 2. 沙箱环境增强

**资源限制**
- CPU 限制：防止单任务耗尽计算资源
- 内存限制：防止内存泄漏导致系统崩溃
- 磁盘限制：防止磁盘空间被占满
- 网络限制：控制出站网络访问

**自动依赖安装**
- Python 依赖：自动检测并安装 requirements.txt
- Node.js 依赖：自动检测并安装 package.json
- 依赖缓存机制，加速重复执行

**V8 运行时支持**
- 解除 RLIMIT_AS 与 cgroup 的强绑定
- 支持 V8 WebAssembly 执行
- 优化 JavaScript 代码执行性能

**工作目录保持**
- 支持设置命令执行的工作目录
- 多步骤任务保持目录状态
- 临时目录自动清理

**业务影响：**
- 提升代码执行安全性
- 支持更复杂的代码执行任务
- 减少环境配置负担

---

### 3. 技能系统升级

**会话级技能**
- 技能按会话隔离，避免相互干扰
- 支持会话内技能热重载
- 技能状态与会话生命周期绑定

**技能编辑能力**
- 可视化技能编辑器
- 支持修改技能描述、参数、示例
- 版本控制和回滚机制

**技能标签解析**
- 用户消息中支持 `@skill_name` 语法
- 自动加载并应用对应技能
- 支持多技能同时激活

**业务影响：**
- 支持更灵活的技能使用场景
- 降低技能开发和维护成本
- 提升技能发现和复用率

---

### 4. 待办事项管理

**功能定位：**
为 Agent 提供任务清单管理能力，支持复杂任务的拆解和追踪。

**核心能力：**

**待办事项读写**
- 创建待办事项（支持优先级、截止日期）
- 更新待办状态（待办/进行中/已完成）
- 读取待办列表（支持筛选和排序）

**文件存储**
- 以 Markdown 格式存储在工作目录
- 支持版本控制（Git 追踪变更）
- 人工和 Agent 可同时编辑

**自动集成**
- SimpleAgent 强制包含 todo 工具
- 任务完成自动更新待办状态
- 支持待办事项的循环依赖检测

**业务影响：**
- Agent 可自主管理复杂任务的执行步骤
- 支持"项目管理"类应用场景
- 提升任务执行的可靠性和可追溯性

---

## 🐛 关键 Bug 修复

### 1. 会话稳定性

**锁机制修复**
- 修复锁释放失败导致的会话死锁
- 添加内存锁过期自动释放机制（TTL 5 分钟）
- 锁状态实时监控和告警

**会话 ID 管理**
- 修复内部 sessionId 被覆盖问题
- 支持父子会话 ID 关联追踪
- 会话异常中断后的自动恢复

### 2. 权限与安全

**外部路径权限**
- 统一使用 `external_paths` 作为外部路径配置键名
- 修复路径更新后沙箱权限不同步问题
- 支持通配符路径配置（如 `/data/*/input`）

**工具权限控制**
- 修复 ToolProxy 白名单失效问题
- 支持工具级别的权限细粒度控制
- 危险操作二次确认机制

### 3. Agent 执行逻辑

**任务完成判断**
- 在任务完成判断中考虑 Agent 配置要求
- 支持自定义完成条件（正则匹配、状态码等）
- 防止过早终止导致的任务未完成

**循环次数优化**
- 默认最大循环次数从 10 增加到 50（SimpleAgent）和 100（TaskExecutor）
- 支持按 Agent 类型配置循环上限
- 循环次数接近上限时自动告警

### 4. 前端稳定性

**数据隔离**
- 修复多会话间的数据污染问题
- 实现严格的消息作用域隔离
- 防止跨会话的状态泄露

**UI 修复**
- 修复折叠按钮在非悬停时不可见
- 修复移动端布局错乱问题
- 修复长消息渲染性能问题

---

## 📦 基础设施变更

### 1. 对象存储迁移

**迁移背景：**
MinIO 在企业级场景下的性能和兼容性存在局限，迁移至 RustFS 以提升稳定性和性能。

**变更内容：**
- 存储后端从 MinIO 迁移至 RustFS
- 保持 S3 API 兼容性，现有代码无需修改
- 支持分布式部署和水平扩展

**配置变更：**
- 环境变量前缀从 `MINIO_` 改为 `S3_`
- 新增 `S3_REGION` 配置项
- 支持 AWS S3 兼容模式

### 2. Docker 镜像优化

**镜像瘦身**
- 将 `texlive-full` 替换为特定包集合，镜像体积减少 2GB
- 多阶段构建，分离编译时和运行时依赖
- 基础镜像升级至 Ubuntu 22.04 LTS

**依赖增强**
- 添加 WeasyPrint 支持 HTML 转 PDF
- 添加 Bun 运行时支持 JavaScript 执行
- 添加 LaTeX 编译支持（`texlive-latex-extra`）

**构建加速**
- 国内镜像源自动切换
- 依赖缓存层优化
- 并行构建支持

### 3. CLI 交互升级

**全屏交互界面**
- 基于 `rich` 库实现全屏终端界面
- 支持表格、树形、进度条等富文本展示
- 实时日志流和状态更新

**命令增强**
- 新增 `sage agent list` 查看 Agent 列表
- 新增 `sage session logs` 查看会话日志
- 新增 `sage mcp status` 查看 MCP 服务状态

---

## ⚠️ 升级注意事项

### Breaking Changes

1. **工具选择机制变更**
   - 内部实现改为工具 ID 化，虽然返回值仍为工具名称列表
   - 自定义 Agent 如继承了工具选择逻辑，需要检查兼容性

2. **对象存储配置变更**
   - MinIO 配置项已弃用，需迁移至 S3 配置
   - 检查 `.env` 文件中的存储相关配置

3. **文件系统工具更名**
   - `update_file` 已重命名为 `file_update`
   - 更新工作流和技能中对该工具的引用

4. **MCP 服务依赖**
   - Brave Search 需要配置 API Key
   - Task Scheduler 需要 SQLite 写入权限

### 升级步骤

1. **代码更新**
   ```bash
   git pull origin v0.9.9-dev
   ```

2. **依赖安装**
   ```bash
   pip install -r requirements.txt
   cd app/web && npm install
   ```

3. **配置迁移**
   - 备份 `.env` 文件
   - 参照 `.env.example` 更新配置项
   - 迁移 MinIO 配置至 S3 配置

4. **数据库初始化**
   - Task Scheduler 会自动创建 SQLite 数据库
   - LLM Provider 表会在首次启动时自动创建

5. **前端构建**
   ```bash
   cd app/web
   npm run build
   ```

6. **服务重启**
   ```bash
   python app/sage_server.py
   ```

---

## 🎯 版本亮点

| 维度 | 亮点 |
|------|------|
| **多智能体** | 支持自定义子智能体，实现复杂任务协作 |
| **任务调度** | 完整的任务生命周期管理，支持定时和循环任务 |
| **工具生态** | 3 个全新 MCP 服务，扩展系统能力边界 |
| **用户体验** | 暗色主题、子任务可视化、模型提供商管理 |
| **企业特性** | 上下文预算管理、沙箱增强、技能系统升级 |
| **稳定性** | 锁机制修复、会话隔离、权限控制增强 |

---

**Full Changelog:** https://github.com/ZHangZHengEric/Sage/compare/v0.9.8...v0.9.9
