# Change Log

## 2026-02-05
- [FibrePrompts] Refined `fibre_system_prompt` (EN/ZH) with clearer formatting and explicit criteria for sub-agent spawning vs. direct execution. Updated tool names in English prompt.
- [FibreSubAgent] Added `sub_agent_requirement_prompt` to explicitly enforce `sys_finish_task` usage for sub-agents, while keeping the parent agent's prompt clean.
- [SandboxFileSystem] Explicitly excluded `.sandbox` directory from `get_file_tree` output to prevent internal sandbox files from being exposed to the agent.
- [FibreOrchestrator] Removed redundant outer loop in `run_loop` and fixed TypeError by passing `max_loop_count` via `session_context.agent_config` instead of `run_stream` argument.
- [FibreAgent] Fixed inheritance issue by making `FibreAgent` inherit from `AgentBase` and calling `super().__init__`, ensuring proper type compatibility with `FibreOrchestrator`.
- [FibreOrchestrator] Renamed `sys_send_message` tool to `sys_delegate_task` to better reflect its function of assigning and executing tasks.
- [FibreOrchestrator] Updated `sys_delegate_task` (formerly `send_message`) to intercept `sys_finish_task` tool calls from sub-agents. It now returns the structured result (status and output) of `sys_finish_task` to the parent agent, instead of just the accumulated conversation text.
- [FibreSubAgent] Injected `fibre_system_prompt` into sub-agents during initialization, ensuring they share the same core system instructions as the parent agent.
- [FibreSubAgent] Refactored `sub_agent.py` to inherit parent configuration (budget, tools, skills) and share the parent's workspace/sandbox. Implemented streaming support in `process_message` to yield `MessageChunk`s with sub-session IDs.
- [FibreOrchestrator] Enhanced `orchestrator.py` to support stream merging. Added an output queue to allow sub-agent message chunks to be streamed back to the user alongside parent messages.
- [FibreAgent] Implemented guaranteed session saving in `orchestrator.py` by wrapping `run_loop` in a `try-except-finally` block. This ensures `session_context.save()` is called for all states (Completed, Interrupted, Error), aligning behavior with `SAgent`.
- [CLI] Enhanced `fibre_cli.py` to gracefully handle `KeyboardInterrupt` (Ctrl+C). Now explicitly cancels and awaits the agent task to ensure cleanup logic (including session saving) executes properly.
- [CLI] Fixed `IndexError: list index out of range` in `orchestrator.py` by adding a check for empty messages before accessing the last message.
- [CLI] Fixed user input not being processed in `fibre_cli.py` by restoring the `messages.append` line which was accidentally removed during the async refactor.
- [CLI] Implemented user interruption in `fibre_cli.py`: Added support for pressing 'Q' or 'q' to gracefully stop the current agent session during execution, using `termios` and `tty` for non-blocking input monitoring.
- [SimpleAgent] Refactored loop termination logic: Moved `sys_finish_task` detection from `_handle_tool_calls` to `_call_llm_and_process_response` to correctly handle tool execution results and ensure proper agent shutdown.
- [FibreAgent] Analyzed and confirmed `sys_send_message` blocking behavior; verified that parent agents wait for sub-agent completion (triggered by `sys_finish_task` or loop limit).
- [ToolManager] Confirmed that `run_tool_async` does not enforce an execution timeout, relying on agent-level loop limits or external cancellation.
- [Sandbox] Fixed `PermissionError` in `sagents/utils/logger.py` when running tools in sandbox. Added try-except block to gracefully handle file logging failures in restricted environments, falling back to console logging.
- [CLI] Fixed `unrecognized arguments` error in `fibre_cli.py` by wrapping global `argparse` execution in `mcp_servers/search/serper_search.py` with `if __name__ == "__main__":`.
- [FibreAgent] Fixed `ValueError` in sandbox creation by updating `fibre_cli.py` to generate session IDs with hyphens instead of colons (e.g., `2026-02-05_10-28-17_bd8e`), avoiding invalid paths for `venv` creation.
- [Observability] Fixed `TypeError: Object of type MessageChunk is not JSON serializable` in `opentelemetry_handler.py` by adding a custom JSON serializer that handles `dataclasses` and objects with `to_dict` methods.

## 2026-02-04
- [CLI] Fixed critical bug in `fibre_cli.py` where long arguments were unrecognized due to global argument parsing in `mcp_servers/search/serper_search.py`.
- [FibreAgent] Created `app/fibre_cli.py` to support FibreAgent command-line interaction, including async stream processing and simplified tool integration.
- [FibreAgent] Refactoring:
  - `FibreTools`: Simplified `sys_finish_task` to merge `summary` and `details` into a single `result` parameter, focusing on execution process and resources.
  - `FibreTools`: Removed `task_goal` from `sys_spawn_agent` signature and documentation, aligning with the pattern where tasks are assigned via `sys_send_message`.
  - `FibreTools`: Added detailed `param_description_i18n` for better Chinese support and documentation.
  - `FibreOrchestrator`: Optimized `_create_combined_tool_manager` to reuse existing `ToolManager` instance instead of creating a new one, improving efficiency and context preservation.
  - `FibreAgent.run_stream` signature cleaned; prompts moved to `sagents/prompts/fibre_agent_prompts.py`.
- [FibreAgent] Completed implementation of FibreAgent core components:
  - Fixed `FibreOrchestrator` to correctly use `run_stream` for `SimpleAgent` execution.
  - Implemented `FibreSubAgent` logic including initialization and message processing loop.
  - Verified agent spawning and communication flow with `test_fibre.py` using mock model.
  - Ensured system prompts are correctly injected via `session_context`.
- [FibreAgent] Implemented initial structure for `FibreAgent` architecture (Parallel Implementation):
  - Created `sagents/fibre` package.
  - Implemented `FibreAgent` container compatible with `SAgent` interface.
  - Implemented `FibreOrchestrator` for sub-agent management and event loop.
  - Implemented `FibreTools` for `sys_spawn_agent` and messaging capabilities.
- [Design] Refactored Liquid Agent design document: renamed "Liquid" to "Fibre" (fiber), "Droplet" to "Strand" (strand), and "Flow" to "Transmission" (transmission), including Chinese concept updates in `FIBRE_AGENT_DESIGN.md`.
- [Sandbox] Implemented automatic path mapping for string arguments (e.g., commands, scripts) in `Sandbox` to resolve "Read-only file system" errors when agents use `/workspace` absolute paths.
- [Sandbox] Verified and optimized Python package installation: packages are installed in `.pylibs` within the session's working directory, ensuring isolation from the host environment.
- [SageDemo] Optimized session ID management: `session_id` is now persistent across the conversation lifecycle and only regenerates when "Clear History" is clicked, ensuring consistent session context for stateful operations.
- [SkillManager] Fixed bug where custom `skill_dirs` (passed via `--skills_path`) were ignored during skill loading. Now correctly scans all configured directories.
- [Sandbox] Disabled `RLIMIT_AS` (virtual memory limit) on macOS to prevent "Sandboxed process died unexpectedly" errors caused by OS-specific memory handling behavior.
- [SessionContext] Fixed `SandboxFileSystem` serialization error by saving `host_path` string instead of object in `save()` method.
- [SessionContext] Added detailed logging to `__init__` (lines 116-119) to debug skill copying process (logging skill manager status, available skills, and copy result/errors).
- [SageDemo] Verified `sage_demo.py` correctly initializes `SkillManager` with `skills_path` from arguments.
- [SageDemo] Fixed critical bug in `generate_response` where `skill_manager` was not passed to `process_stream`, causing skills to be unavailable during conversation.
- [Sandbox] Added `/usr/share/zoneinfo` and `/etc/localtime` to default allowed paths to fix `pandas`/`dateutil` import errors in sandboxed environment.
- [Sandbox] Added `/etc/mime.types`, `/etc/apache2/mime.types`, `/etc/httpd/mime.types`, and `/usr/local/etc/mime.types` to default allowed paths to fix `openpyxl`/`mimetypes` import errors.
